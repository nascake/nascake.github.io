

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <title>开个蛋糕店赚nas</title>
            <meta name="viewport"
                content="width=device-width, initial-scale=1, maximum-scale=1">
                <link rel="stylesheet" href="./resources/layui/css/layui.css">
                    <link rel="stylesheet" href="./resources/css/global.css">
    </head>
    <body>
        
        <div class="fly-header layui-bg-black">
            <div class="layui-container">
                
 
                
                
                <ul class="layui-nav fly-nav layui-hide-xs">
                    
       
                    
                    <li class="layui-nav-item"><a href="index.html"><i
                        class="layui-icon">&#xe664;</i> 买个蛋糕吃出nas</a></li>
                    
                    
                    <li class="layui-nav-item"><a href="index.html"> <i
                        class="layui-icon"></i>
                    </a></li>
                    
                    <li class="layui-nav-item layui-this"><a href="shop.html"> <i
                        class="layui-icon">&#xe68e;</i> 开个蛋糕店赚nas
                    </a></li>
                    
                   
                </ul>
                
                <ul class="layui-nav fly-nav-user">
                    
                    <li class="layui-nav-item"><a href="javascript:void(0);"
                        onclick="showhelp()">规则说明</a></li>
                    
                    <li class="layui-nav-item"><a
                        href="mailto:weizhitechinfo@163.com" target="_blank">联系我们</a></li>
                    
                </ul>
                
                
            </div>
        </div>
        
        
        
        <div class="fly-panel fly-column">
            <div class="layui-container">
                <ul class="layui-clear">
                    
                    <li class="layui-hide-xs layui-this"><a href="https://github.com/ChengOrangeJu/WebExtensionWallet" target="_blank"> 安装星云插件</a></li>
                    <li class="layui-hide-xs layui-this">选择蛋糕藏入nas,顾客按价格支付的nas直接进入您钱包，藏有nas的蛋糕被购买则店铺破产（上链10秒左右，请耐心等待）</li>
                    
                </ul>
            </div>
        </div>
        
        
        <div class="fly-main" style="overflow: hidden;">
            
            
            <form class="layui-form layui-form-pane" action="">
                <input type="hidden" value="" id="cakeid" />
                
                <div class="layui-form-item">
                    <label class="layui-form-label">藏入星云币</label>
                    <div class="layui-input-inline">
                        <input name="nastotal" id="nastotal" lay-verify="required"
                            placeholder="请输入" autocomplete="off" class="layui-input"
                            type="text">
                            </div>
                    
                    <label class="layui-form-label">蛋糕价格</label>
                    <div class="layui-input-inline">
                        <input name="price" id="price" lay-verify="required"
                            placeholder="请输入" autocomplete="off" class="layui-input"
                            type="text">
                            </div>
                    <button class="layui-btn layui-btn-warm" type="button"
                        onclick="return false;" id="store">开店</button>
                    
                </div>
                
            </form>
            
            
            <ul class="fly-case-list">
                <li data-id="c1" id="1"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(1)"> <img
                        src="./resources/images/cake_01.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                <li data-id="c2" id="2"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(2)"> <img
                        src="./resources/images/cake_02.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                
                <li data-id="c3" id="3"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(3)"> <img
                        src="./resources/images/cake_03.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                
                <li data-id="c4" id="4"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(4)"> <img
                        src="./resources/images/cake_04.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                <li data-id="c5" id="5"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(5)"> <img
                        src="./resources/images/cake_05.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                <li data-id="c6" id="6"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(6)"> <img
                        src="./resources/images/cake_06.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                <li data-id="c7" id="7"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(7)"> <img
                        src="./resources/images/cake_07.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                <li data-id="c8" id="8"><a class="fly-case-img"
                    href="javascript:void(0);" onclick="selectcake(8)"> <img
                        src="./resources/images/cake_08.jpg"> <cite
                            class="layui-btn layui-btn-primary layui-btn-small">选我</cite>
                        </a></li>
                
                
            </ul>
            
            
            <fieldset class="layui-elem-field layui-field-title"
                style="margin-top: 20px;">
                <legend>我的店铺</legend>
            </fieldset>
            <table class='layui-table' lay-skin='line' id="showRes">
                <thead>
                    <tr>
                        <th>店铺编码</th>
                        <th>开店成本</th>
                        <th>蛋糕价格</th>
                        <th>营业额</th>
                        <th>当前状况</th>
                    </tr>
                </thead>
                <tbody id="shops">
                </tbody>
            </table>
            
            
        </div>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        <div class="fly-footer">
            <p>Copyright ©星云蛋糕店</p>
            <p>
            Email:<a href="mailto:weizhitechinfo@163.com" target="_blank"
                class="">weizhitechinfo@163.com</a>
            </p>
        </div>
        
        <script src="./resources/layui/layui.js"></script>
        <script src="./resources/js/lib/jquery-3.3.1.min.js"></script>
        <script src="./resources/js/lib/nebulas.js"></script>
        <script src="./resources/js/lib/nebPay.js"></script>
        
        
        
        <script>
            
            
            
            "use strict";
            
            
            var nebulas = require("nebulas"),
            Account = nebulas.Account,
            neb = new nebulas.Neb();
            neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
            
            var NebPay = require("nebpay");
            var nebPay = new NebPay();
            
            
            var dappAddress = "n1qT55ZX6CJUqvvwxCwVjgVLaVoW6hBtkJE";
            
            //var dappAddress = "n1fEWvWvEtzPvMY9aRXQyojW5qh1q8FPvBL";
            
            
            
            
            function getWallectInfo(){
                window.postMessage({
                                   "target": "contentscript",
                                   "data": {},
                                   "method": "getAccount",
                                   }, "*");
                                   
                                   
                                   
                                   window.addEventListener('message', function (e) {
                                                           if (e.data && e.data.data && e.data.data.account) {
                                                           var wallect =  e.data.data.account;
                                                           initInfo(wallect);
                                                           }
                                                           });
            }
        
        
        getWallectInfo();
        
        function initInfo(wallect){
            
            load();
            var from = wallect;
            var to = dappAddress;
            var value = "0";
            var callFunction = "getCreateRounds";
            var callArgs = "[\"" + from + "\"]"; //in the form of ["args"]
            nebPay.simulateCall(to, value, callFunction, callArgs, {
                                listener: showHistory
                                });
        }
        
        
        function showHistory(resp){
            
            cancelLoad();
            var rounds = JSON.parse(resp.result);
            
            var html = "";
            if(rounds){
                for (var i = 0; i <  rounds.length; i++)
                {
                    var record = rounds[i];
                    var  statusDes = "经营中";
                    if(record.status == '0'){
                        statusDes = "已经破产";
                    }
                    html = html + "<tr><td>"+record.roundCode+"</td><td>"+record.tnas/1000000000000000000+"nas</td><td>"+record.price+"nas</td><td>"+record.winnas/1000000000000000000+"nas</td><td>"+statusDes+"</td></tr>";
                }
            }
            
            $("#shops").html(html);
            
        }
        
        
        
        function selectcake(id) {
            
            for(var i=1 ; i<9 ; i++){
                
                
                $("#"+i).removeClass();
                
            }
            
            $("#cakeid").val(id);
            $("#"+id).addClass("layui-bg-orange");
            
        }
        
        
        
        $("#store").click(function(){
                          var to = dappAddress;
                          var value = $("#nastotal").val();
                          var callFunction = "store";
                          
                          
                          
                          var cakeId = $("#cakeid").val();
                          var price = $("#price").val();
                          var roundCode = new Date().getTime();
                          
                          if(!isRealNum(value)){
                          alert("藏入的星云币不合法");
                          return;
                          }
                          
                          if(!isRealNum(price)){
                          alert("蛋糕价格不合法");
                          return;
                          }
                          
                          if (cakeId == "" || price == "" || value == "" ){
                          alert("必须选择一个蛋糕，且藏入的星云币和价格不能为0");
                          return ;
                          }
                          
                          load();
                          
                          var callArgs = "[\"" + roundCode + "\",\"" + cakeId + "\",\"" + price + "\"]"; //
                          nebPay.call(to, value, callFunction, callArgs, { listener: show});
                          
                          });
                          
                          
                          
                          
                          
                          var intervalQuery
                          var txhash 
                          function show(resp){
                              
                              console.log("response of push: " + JSON.stringify(resp));
                              txhash = resp.txhash
   
                                  intervalQuery = setInterval(function () {
                                                              funcIntervalQuery();
                                                              }, 5000);
                            
                              
                          }
        
 
 
 
 
 
        
        function funcIntervalQuery() {
            neb.api.getTransactionReceipt(txhash).then( function (receipt) {
                                          
                                          console.log("response of tx: " + JSON.stringify(receipt));
                                          if( receipt.status === 1){
                                          showres();
                                          clearInterval(intervalQuery)
                                          }
                                          
                                          });
        }
        
        
        
        function showres(){
            cancelLoad();
            layui.use('layer', function(){
                      var layer = layui.layer;
                      layer.confirm('蛋糕店已经成功上链，等着数nas吧', {
                                    btn: ['确定'] //按钮
                                    }, function(){
                                    location.reload();
                                    });
                      });
                      
        }
        
        
        function load(){
            layui.use('layer', function(){
                      var layer = layui.layer;
                      
                      layer.load(1, {
                                 shade: [0.4,'#fff'] //0.1透明度的白色背景
                                 });
                      });
        }
        
        function cancelLoad(){
            layui.use('layer', function(){
                      var layer = layui.layer;
                      layer.closeAll('loading');
                      });
        }
        
        function showhelp(){
            layui.use('layer', function(){
                      var layer = layui.layer;
                      
                      layer.open({
                                 type: 1,
                                 title: "规则说明",
                                 closeBtn: 1,
                                 shadeClose: true,
                                 area: ['450px', '300px'],
                                 content: "<div style='line-height:26px;padding-right:20px;padding-left:15px;'><strong>开店：</strong>设定蛋糕的售卖价格，同时选择蛋糕藏入一定数量的星云币作为奖励金额，提交后开店完成。一个钱包同时可开多家店铺。<br><strong>盈利：</strong>购买者按蛋糕价格支付的nas直接进入开店者账户。<br><strong>破产：</strong>如果购买者所获得的蛋糕为藏有星云币的蛋糕，则获得蛋糕内星云币,店铺进入破产状态。<br><strong>挑选：</strong>买中藏有nas的蛋糕概率为1/8，可通过店铺切换对比蛋糕价格和奖励金额，选择合适的店铺进行购买。<br><strong>购买：</strong>按开店者设定的蛋糕价格支付,合约随机返回蛋糕，如其为藏有星云币的蛋糕则可获得内部所藏的nas。<br></div>"
                                 });
                      });
        }
        
        
        function isRealNum(val){
            if(val === "" || val ==null){
                return false;
            }
            if(!isNaN(val)){
                return true;
            }else{
                return false;
            }
        }
        
            </script>
        
        
        
    </body>
</html>